name: Legg til deploy-knapper
on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  pull-requests: write

jobs:
  legg-til-deploy-kommentar:
    name: Legg til deploy-knapper
    runs-on: ubuntu-latest
    steps:
      - name: Legg til deploy-knapp i PR
        uses: actions/github-script@v8
        with:
          script: |
            const devWorkflowId = 'deploy-til-dev.yml';
            const demoWorkflowId = 'deploy-til-demo.yml';

            // Fetch existing comments
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            // Check if we already have a deploy comment
            const hasAlreadyAddedDeployComment = comments.data.some(comment => 
              comment.body.includes('ðŸš€ Deploy')
            );

            if (!hasAlreadyAddedDeployComment) {
              const comment = `## ðŸš€ Deploy

              Vil du deploye denne branchen noe sted?

              [![Deploy til dev-miljÃ¸](https://img.shields.io/badge/Deploy-til_dev-blue?style=for-the-badge)](${context.payload.repository.html_url}/actions/workflows/${devWorkflowId})
              
              [![Deploy til demo-miljÃ¸](https://img.shields.io/badge/Deploy-til_demo-green?style=for-the-badge)](${context.payload.repository.html_url}/actions/workflows/${demoWorkflowId})

              Klikk pÃ¥ knappen over, trykk "Run workflow", velg branchen "${context.payload.pull_request.head.ref}" og trykk pÃ¥ den grÃ¸nne knappen.`;

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
